@page "/admin/users"
@using System.Net.Http.Json
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject NavigationManager Nav
@attribute [Authorize]

<h3>Administración de Usuarios</h3>

@if (loading)
{
    <p>Cargando...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
else
{
    <table class="table">
        <thead>
            <tr><th>Email</th><th>Roles</th><th>Claims</th><th>Acciones</th></tr>
        </thead>
        <tbody>
            @foreach (var u in users)
            {
                <tr>
                    <td>@u.Email</td>
                    <td>@string.Join(", ", u.Roles)</td>
                    <td>
                        @foreach (var c in u.Claims)
                        {
                            <span class="badge bg-secondary">@($"{c.Type}:{c.Value}")&nbsp;</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" @onclick="() => AddReportsViewClaimAsync(u.Id)">Add reports.view</button>
                        <button class="btn btn-sm btn-success" @onclick="() => GiveAdminRoleAsync(u.Id)">Give Admin</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private bool loading = true;
    private string? error;

    class UserDto
    {
        public string Id { get; set; } = "";
        public string Email { get; set; } = "";
        public List<string> Roles { get; set; } = new();
        public List<UserClaimDto> Claims { get; set; } = new();
    }
    class UserClaimDto { public string Type { get; set; } = ""; public string Value { get; set; } = ""; }

    private List<UserDto> users = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        loading = true;
        error = null;
        try
        {
            var resp = await Http.GetAsync("api/admin/users");
            if (!resp.IsSuccessStatusCode)
            {
                error = $"Error: {resp.StatusCode}";
                users = new();
                return;
            }
            users = await resp.Content.ReadFromJsonAsync<List<UserDto>>() ?? new();
        }
        catch (Exception ex)
        {
            error = ex.Message;
            users = new();
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    // Wrappers para evitar problemas de Razor con comillas en lambdas
    private async Task GiveAdminRoleAsync(string userId)
    {
        await AssignRoleAsync(userId, "Admin");
    }

    private async Task AddReportsViewClaimAsync(string userId)
    {
        await AddClaimAsync(userId, "permission", "reports.view");
    }

    // Funciones que llaman a la API - envían JSON en el body
    private async Task AssignRoleAsync(string userId, string role)
    {
        try
        {
            var dto = new { UserId = userId, Role = role };
            var r = await Http.PostAsJsonAsync("api/admin/assign-role", dto);
            if (r.IsSuccessStatusCode)
            {
                await LoadUsers();
                error = null;
            }
            else
            {
                // intenta leer mensaje de error del servidor
                var body = await r.Content.ReadAsStringAsync();
                error = $"AssignRole error: {r.StatusCode} - {body}";
            }
        }
        catch (Exception ex) { error = ex.Message; }
    }

    private async Task AddClaimAsync(string userId, string type, string value)
    {
        try
        {
            var dto = new { UserId = userId, Type = type, Value = value };
            var r = await Http.PostAsJsonAsync("api/admin/add-claim", dto);
            if (r.IsSuccessStatusCode)
            {
                await LoadUsers();
                error = null;
            }
            else
            {
                var body = await r.Content.ReadAsStringAsync();
                error = $"AddClaim error: {r.StatusCode} - {body}";
            }
        }
        catch (Exception ex) { error = ex.Message; }
    }
}