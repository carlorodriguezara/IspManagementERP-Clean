@using MudBlazor
@inject IspManagementERP.Client.Services.Identity.UserService UserService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Roles — @UserEmail</MudText>
        <MudDivider Class="my-2" />

        @if (IsLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
            </div>
        }
        else
        {
            <MudText Typo="Typo.subtitle2" Class="mb-1">Asignados</MudText>
            @if (UserRoles == null || !UserRoles.Any())
            {
                <MudText color="Color.Secondary">No tiene roles.</MudText>
            }
            else
            {
                <MudList Dense="true">
                    @foreach (var r in UserRoles)
                    {
                        <MudListItem>
                            <MudText>@r</MudText>
                            <MudSpacer />
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="() => RemoveRole(r)" Disabled="@IsProcessing">Quitar</MudButton>
                        </MudListItem>
                    }
                </MudList>
            }

            <MudDivider Class="my-2" />

            <MudText Typo="Typo.subtitle2" Class="mb-1">Disponibles</MudText>
            @if (AllRoles == null || !AllRoles.Any())
            {
                <MudText color="Color.Secondary">No roles definidos.</MudText>
            }
            else
            {
                <div class="d-flex flex-column gap-2">
                    @foreach (var r in AllRoles.Except(UserRoles ?? Enumerable.Empty<string>()))
                    {
                        <div class="d-flex align-center">
                            <MudText>@r</MudText>
                            <MudSpacer />
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="() => AddRole(r)" Disabled="@IsProcessing">Asignar</MudButton>
                        </div>
                    }
                </div>
            }
        }

        @if (!string.IsNullOrEmpty(Error))
        {
            <MudAlert Severity="Severity.Error" Elevation="0" Class="mt-2">@Error</MudAlert>
        }
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Close">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string UserId { get; set; } = "";
    [Parameter] public string UserEmail { get; set; } = "";

    private bool IsLoading;
    private bool IsProcessing;
    private List<string> AllRoles = new();
    private HashSet<string> UserRoles = new();
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        await LoadRolesAsync();
    }

    private async Task LoadRolesAsync()
    {
        try
        {
            IsLoading = true;
            Error = null;
            AllRoles = (await UserService.GetRolesAsync())?.ToList() ?? new List<string>();
            var ur = await UserService.GetUserRolesAsync(UserId);
            UserRoles = new HashSet<string>(ur ?? Enumerable.Empty<string>());
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task AddRole(string role)
    {
        try
        {
            IsProcessing = true;
            var resp = await UserService.AddUserRoleAsync(UserId, role);
            if (!resp.IsSuccessStatusCode)
            {
                var txt = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error asignando rol: {txt}", Severity.Error);
            }
            else
            {
                Snackbar.Add($"Rol '{role}' asignado", Severity.Success);
            }
            await LoadRolesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task RemoveRole(string role)
    {
        try
        {
            IsProcessing = true;
            var resp = await UserService.RemoveUserRoleAsync(UserId, role);
            if (!resp.IsSuccessStatusCode)
            {
                var txt = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error quitando rol: {txt}", Severity.Error);
            }
            else
            {
                Snackbar.Add($"Rol '{role}' removido", Severity.Success);
            }
            await LoadRolesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private void Close() => MudDialog.Close();
}