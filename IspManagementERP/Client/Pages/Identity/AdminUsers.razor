@page "/admin/users"
@using IspManagementERP.Shared.Identity
@using IspManagementERP.Client.Shared
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Diagnostics
@inject IspManagementERP.Client.Services.Identity.UserService UserService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudPaper Class="pa-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h5">Administración de Usuarios</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@EventCallback.Factory.Create(this, CreateUser)">Crear usuario</MudButton>
    </div>

    @if (IsLoading)
    {
        <div class="d-flex justify-center my-6">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (Error is not null)
    {
        <MudAlert Severity="Severity.Error">@Error</MudAlert>
    }
    else
    {
        <MudTable Items="users" Elevation="0" Bordered="true" Hover="true">
            <HeaderContent>
                <MudTh>Email</MudTh>
                <MudTh>Usuario</MudTh>
                <MudTh>Roles</MudTh>
                <MudTh>Activo</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Usuario">@context.UserName</MudTd>
                <MudTd DataLabel="Roles">@context.RolesCount</MudTd>
                <MudTd DataLabel="Activo">@((context.IsEnabled) ? "Sí" : "No")</MudTd>
                <MudTd DataLabel="Acciones">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => EditUser(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Block" Color="Color.Warning" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => ConfirmSuspend(context.Id, context.Email))" />
                    <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => EnableUser(context.Id))" />
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</MudPaper>

@code {
    private List<UserDto> users = new();
    private bool IsLoading;
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
       
        await LoadUsersAsync();
    }

    public async Task LoadUsersAsync()
    {
       
        IsLoading = true;
        Error = null;
        try
        {
            var result = await UserService.GetAllUsersAsync();
            if (result is null)
            {
                users = new List<UserDto>();
                Error = "No se pudieron cargar usuarios (respuesta nula). Revisa la API o la autorización.";
                Snackbar.Add("No se pudieron cargar usuarios. Revisa logs.", Severity.Warning);
            }
            else
            {
                users = result;
            }
        }
        catch (Exception ex)
        {
            users = new List<UserDto>();
            Error = ex.Message;
            Snackbar.Add("Error cargando usuarios: " + ex.Message, Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    // --------- Actions used by buttons (asegúrate de que existen en el componente)
    private async Task EditUser(string userId)
    {
        var parameters = new DialogParameters { ["UserId"] = userId };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<EditUserModal>($"Editar — {userId}", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled)
            await LoadUsersAsync();
    }

    private async Task CreateUser()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<EditUserModal>("Crear usuario", options);
        var result = await dialog.Result;
        if (!result.Cancelled)
            await LoadUsersAsync();
    }

    private async Task ConfirmSuspend(string userId, string? email)
    {
        var parameters = new DialogParameters { ["Message"] = $"¿Suspender usuario {email}?" };
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = DialogService.Show<DeleteConfirm>("Confirmar", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled && result.Data is bool confirmed && confirmed)
            await SuspendUser(userId);
    }

    private async Task SuspendUser(string userId)
    {
        try
        {
            var resp = await UserService.SuspendUserAsync(userId);
            if (resp.IsSuccessStatusCode) Snackbar.Add("Usuario suspendido", Severity.Success);
            else
            {
                var body = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error suspendiendo usuario: {resp.StatusCode} - {body}", Severity.Error);
            }
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
    }

    private async Task EnableUser(string userId)
    {
        try
        {
            var resp = await UserService.EnableUserAsync(userId);
            if (resp.IsSuccessStatusCode) Snackbar.Add("Usuario habilitado", Severity.Success);
            else
            {
                var body = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error habilitando usuario: {resp.StatusCode} - {body}", Severity.Error);
            }
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
    }
}