@page "/admin/users"
@using IspManagementERP.Shared.Identity
@using IspManagementERP.Client.Shared
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject IspManagementERP.Client.Services.Identity.UserService UserService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavManager

<MudPaper Class="pa-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h5">Administración de Usuarios</MudText>
        <div>
            <MudButton Variant="Variant.Outlined" Color="Color.Info" Class="me-2" OnClick="@OpenAdminClaims">Claims</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@EventCallback.Factory.Create(this, CreateUser)">Crear usuario</MudButton>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="d-flex justify-center my-6">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (Error is not null)
    {
        <MudAlert Severity="Severity.Error">@Error</MudAlert>
    }
    else
    {
        <MudTable Items="users" Elevation="0" Bordered="true" Hover="true">
            <HeaderContent>
                <MudTh>Email</MudTh>
                <MudTh>Usuario</MudTh>
                <MudTh>Roles</MudTh>
                <MudTh>Activo</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Usuario">@context.UserName</MudTd>
                <MudTd DataLabel="Roles">@context.RolesCount</MudTd>
                <MudTd DataLabel="Activo">@((context.IsEnabled) ? "Sí" : "No")</MudTd>
                <MudTd DataLabel="Acciones">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => EditUser(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Block" Color="Color.Warning" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => ConfirmSuspend(context.Id, context.Email))" />
                    <MudIconButton Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => EnableUser(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Group" Color="Color.Primary" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => OpenRoleAssign(context.Id, context.Email))" Title="Asignar roles" />
                    <MudIconButton Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Info" Size="Size.Small"
                                   OnClick="@EventCallback.Factory.Create(this, () => OpenClaimsModal(context.Id, context.Email))" Title="Claims del usuario" />
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</MudPaper>

@code {
    private List<UserDto> users = new();
    private bool IsLoading;
    private string? Error;

    // Query reopen support
    private string? _reopenRoleModalFor;
    private string? _reopenClaimsModalFor;

    protected override async Task OnInitializedAsync()
    {
        ParseOpenModalQuery();           // lee query params si vienen
        await LoadUsersAsync();
        await HandleReopenQueryIfAny();  // abre modal si es necesario
    }

    private void ParseOpenModalQuery()
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var dict = ParseQuery(uri.Query);
        if (dict.TryGetValue("reopenRoleModalFor", out var roleUserId))
            _reopenRoleModalFor = roleUserId;
        if (dict.TryGetValue("reopenClaimsModalFor", out var claimsUserId))
            _reopenClaimsModalFor = claimsUserId;
    }

    private async Task HandleReopenQueryIfAny()
    {
        if (!string.IsNullOrEmpty(_reopenRoleModalFor))
        {
            // Esperamos que users ya esté cargado para mostrar email
            var user = users.FirstOrDefault(u => u.Id == _reopenRoleModalFor);
            await OpenRoleAssign(_reopenRoleModalFor, user?.Email);
            RemoveQueryFromUrl();
        }
        else if (!string.IsNullOrEmpty(_reopenClaimsModalFor))
        {
            var user = users.FirstOrDefault(u => u.Id == _reopenClaimsModalFor);
            await OpenClaimsModal(_reopenClaimsModalFor, user?.Email);
            RemoveQueryFromUrl();
        }
    }

    private void RemoveQueryFromUrl()
    {
        var baseUri = NavManager.Uri.Split('?')[0];
        NavManager.NavigateTo(baseUri, replace: true);
    }

    public async Task LoadUsersAsync()
    {
        IsLoading = true;
        Error = null;
        try
        {
            var result = await UserService.GetAllUsersAsync();
            if (result is null)
            {
                users = new List<UserDto>();
                Error = "No se pudieron cargar usuarios (respuesta nula). Revisa la API o la autorización.";
                Snackbar.Add("No se pudieron cargar usuarios. Revisa logs.", Severity.Warning);
            }
            else
            {
                users = result;
            }
        }
        catch (Exception ex)
        {
            users = new List<UserDto>();
            Error = ex.Message;
            Snackbar.Add("Error cargando usuarios: " + ex.Message, Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    // Actions (same as before)
    private async Task EditUser(string userId) { /* ... existing code ... */ }
    private async Task CreateUser() { /* ... existing code ... */ }
    private async Task ConfirmSuspend(string userId, string? email) { /* ... existing code ... */ }
    private async Task SuspendUser(string userId) { /* ... existing code ... */ }
    private async Task EnableUser(string userId) { /* ... existing code ... */ }

    private async Task OpenRoleAssign(string userId, string? email)
    {
        var parameters = new DialogParameters { ["UserId"] = userId, ["UserEmail"] = email };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<RoleAssignModal>($"Roles — {email}", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled) await LoadUsersAsync();
    }

    private async Task OpenClaimsModal(string userId, string? email)
    {
        var parameters = new DialogParameters { ["UserId"] = userId, ["UserEmail"] = email };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<ClaimsModal>($"Claims — {email}", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled) await LoadUsersAsync();
    }

    private void OpenAdminClaims()
    {
        NavManager.NavigateTo("/admin/claimdefinitions");
    }

    // small query parser (no external dep)
    private static Dictionary<string, string> ParseQuery(string query)
    {
        var dict = new Dictionary<string, string>();
        if (string.IsNullOrEmpty(query)) return dict;
        var q = query;
        if (q.StartsWith("?")) q = q.Substring(1);
        var parts = q.Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var p in parts)
        {
            var idx = p.IndexOf('=');
            if (idx >= 0)
            {
                var key = Uri.UnescapeDataString(p.Substring(0, idx));
                var val = Uri.UnescapeDataString(p.Substring(idx + 1));
                dict[key] = val;
            }
            else
            {
                dict[Uri.UnescapeDataString(p)] = "";
            }
        }
        return dict;
    }
}