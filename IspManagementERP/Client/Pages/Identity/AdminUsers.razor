@page "/admin/users"
@using IspManagementERP.Shared.Identity
@using IspManagementERP.Client.Shared
@inject IspManagementERP.Client.Services.Identity.UserService UserService
@inject NavigationManager NavigationManager

<h3 class="mb-4">Administración de Usuarios</h3>

<div class="row mb-3">
    <div class="col-md-6">
        <input class="form-control" placeholder="Buscar por email o usuario..." @bind="searchQuery" @bind:event="oninput" />
    </div>
    <div class="col-md-6 text-end">
        <button class="btn btn-success" @onclick="CreateUser" disabled="@IsProcessing">Crear usuario</button>
    </div>
</div>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

<table class="table table-striped">
    <thead>
        <tr>
            <th>Email</th>
            <th>Usuario</th>
            <th>Roles</th>
            <th style="width:220px">Acciones</th>
        </tr>
    </thead>
    <tbody>
        @if (IsLoading)
        {
            <tr>
                <td colspan="4">Cargando...</td>
            </tr>
        }
        else if (users == null || !users.Any())
        {
            <tr>
                <td colspan="4">No hay usuarios.</td>
            </tr>
        }
        else
        {
            @foreach (var u in users)
            {
                <tr>
                    <td>@u.Email</td>
                    <td>@u.UserName</td>
                    <td>@(u.Roles?.Count() ?? 0)</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" @onclick="() => OpenRoleModal(u)" disabled="@IsProcessing">Roles</button>
                        <button class="btn btn-sm btn-secondary me-1" @onclick="() => EditUser(u.Id)" disabled="@IsProcessing">Editar</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteUser(u.Id, u.Email)" disabled="@IsProcessing">Borrar</button>
                        <button type="button" class="btn btn-sm btn-secondary" @onclick="() => OpenClaimsModal(u)">Claims</button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<div class="d-flex justify-content-between align-items-center mt-3">
    <div>Mostrando página @(page) / @totalPages (@total registros)</div>
    <div>
        <button class="btn btn-outline-primary btn-sm me-2" @onclick="PrevPage" disabled="@(page == 1 || IsLoading)">Anterior</button>
        <button class="btn btn-outline-primary btn-sm" @onclick="NextPage" disabled="@(page >= totalPages || IsLoading)">Siguiente</button>
    </div>
</div>

<!-- Modales -->
<RoleAssignModal @ref="roleAssignModal" />
<EditUserModal @ref="editModal" />
<DeleteConfirm @ref="deleteConfirm" />
<ClaimsModal @ref="claimsModal" OnOpenClaimDefinitions="OpenAdminClaimsModal" />
<AdminClaims @ref="adminClaimsModal" />

@code {
    private List<UserWithRolesClaimsDto> users = new();
    private int page = 1;
    private int pageSize = 20;
    private int total = 0;
    private int totalPages = 1;
    private string? searchQuery;
    private bool IsLoading = false;
    private bool IsProcessing = false;
    private string? ErrorMessage;

    private RoleAssignModal? roleAssignModal;
    private EditUserModal? editModal;
    private DeleteConfirm? deleteConfirm;
    private ClaimsModal? claimsModal;
    private AdminClaims? adminClaimsModal;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        IsLoading = true;
        ErrorMessage = null;
        try
        {
            var result = await UserService.GetUsersPagedAsync(page, pageSize, searchQuery);
            users = result.items?.ToList() ?? new List<UserWithRolesClaimsDto>();
            total = result.total;
            totalPages = total > 0 ? (int)Math.Ceiling(total / (double)pageSize) : 1;
            if (page > totalPages) page = totalPages;
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error cargando usuarios: " + ex.Message;
            users = new List<UserWithRolesClaimsDto>();
            total = 0;
            totalPages = 1;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenRoleModal(UserWithRolesClaimsDto user)
    {
        if (roleAssignModal == null) return;
        await roleAssignModal.ShowAsync(user.Id, user.Email);
        // No llames aquí a RemoveRole o RemoveUserRoleAsync
    }

    private async Task CreateUser()
    {
        if (editModal == null) return;
        await editModal.ShowCreateAsync();
        // tras crear (si se creó) recargar
        await LoadUsers();
    }

    private async Task EditUser(string userId)
    {
        if (editModal == null) return;
        await editModal.ShowEditAsync(userId);
        await LoadUsers();
    }

    private async Task DeleteUser(string userId, string userEmail)
    {
        if (deleteConfirm == null) return;
        try
        {
            var confirmed = await deleteConfirm.ShowAsync($"¿Borrar usuario {userEmail}?");
            if (!confirmed) return;

            IsProcessing = true;
            var resp = await UserService.DeleteUserAsync(userId);
            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                ErrorMessage = $"Error borrando usuario: {resp.StatusCode}. {body}";
            }
            else
            {
                await LoadUsers();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error borrando usuario: " + ex.Message;
        }
        finally
        {
            IsProcessing = false;
        }
    }
    private async Task OpenClaimsModal(UserWithRolesClaimsDto user)
    {
        if (claimsModal == null) return;
        await claimsModal.ShowAsync(user.Id, user.Email);
    }

    // Este método se pasa como callback al ClaimsModal; cuando el usuario pulsa "Gestionar definiciones"
    // el ClaimsModal invoca este método y lo que hacemos aquí es abrir el AdminClaimsModal
    private async Task OpenAdminClaimsModal()
    {
        if (adminClaimsModal == null) return;
        await adminClaimsModal.ShowAsync();
    }

    private async Task PrevPage()
    {
        if (page <= 1) return;
        page--;
        await LoadUsers();
    }

    private async Task NextPage()
    {
        if (page >= totalPages) return;
        page++;
        await LoadUsers();
    }
}