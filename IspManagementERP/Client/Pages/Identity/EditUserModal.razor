@using MudBlazor
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using IspManagementERP.Shared.Identity
@inject IspManagementERP.Client.Services.Identity.UserService UserService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">@Title</MudText>

        @if (IsLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
            </div>
        }
        else
        {
            <MudForm @ref="form" Class="mt-2">
                <MudTextField T="string" @bind-Value="Model.Email" Label="Email" Required="true" />
                <MudTextField T="string" @bind-Value="Model.UserName" Label="Usuario" Required="true" />
                <MudTextField T="string" @bind-Value="Model.PhoneNumber" Label="Phone" />

                <MudTextField T="string" @bind-Value="Model.FirstName" Label="Nombre" />
                <MudTextField T="string" @bind-Value="Model.LastName" Label="Apellido" />
                <MudTextField T="string" @bind-Value="Model.Address" Label="Dirección" />

                <div class="mt-2">
                    <label class="mud-typography mud-typography-caption">Foto de perfil (preview)</label>
                    @if (!string.IsNullOrEmpty(ProfilePreview))
                    {
                        <div class="my-2">
                            <img src="@ProfilePreview" alt="Profile preview" style="max-width:120px; max-height:120px; border-radius:6px;" />
                        </div>
                    }
                    <InputFile OnChange="OnInputFileChange" />
                    <MudText Typo="Typo.caption" Class="text-muted">Formato recomendado: JPG/PNG. El fichero no se sube automáticamente; implementa endpoint si quieres guardarlo en servidor.</MudText>
                </div>

                <MudCheckBox T="bool" @bind-Value="ModelIsEnabled" Label="Habilitado" Class="mt-2" />

                @if (_isSuperAdmin)
                {
                    <MudTextField T="string" @bind-Value="ModelTenantIdString" Label="TenantId (solo SuperAdmin)" />
                }

                @if (!string.IsNullOrEmpty(Error))
                {
                    <MudAlert Severity="Severity.Error" Elevation="0" Class="mt-2">@Error</MudAlert>
                }
            </MudForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel" Disabled="@IsProcessing">Cancelar</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsync" Disabled="@IsProcessing">@SaveLabel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string? UserId { get; set; }

    private MudForm? form;
    private bool IsLoading;
    private bool IsProcessing;
    private bool IsCreate;
    private string Title = "Editar usuario";
    private string SaveLabel = "Guardar";
    private string Error = "";
    private UserDto Model = new();
    private bool _isSuperAdmin = false;
    private IBrowserFile? _selectedFile;
    private string? ProfilePreview;

    private bool ModelIsEnabled
    {
        get => Model.IsEnabled;
        set => Model.IsEnabled = value;
    }

    private string ModelTenantIdString
    {
        get => Model.TenantId.ToString();
        set
        {
            if (int.TryParse(value, out var t)) Model.TenantId = t;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isSuperAdmin = user.Identity?.IsAuthenticated == true &&
                        (user.IsInRole("SuperAdmin") || user.HasClaim(c => c.Type == "scope" && c.Value == "admin.global"));

        if (string.IsNullOrWhiteSpace(UserId))
        {
            IsCreate = true;
            Title = "Crear usuario";
            SaveLabel = "Crear";
            Model = new UserDto();
            ProfilePreview = null;
        }
        else
        {
            IsCreate = false;
            Title = "Editar usuario";
            SaveLabel = "Guardar";
            await LoadUserAsync(UserId);
        }
    }

    private async Task LoadUserAsync(string userId)
    {
        try
        {
            IsLoading = true;
            Error = "";
            var dto = await UserService.GetUserDetailsAsync(userId);
            if (dto != null)
            {
                Model = dto;
                if (!string.IsNullOrEmpty(dto.ProfilePictureBase64))
                    ProfilePreview = $"data:image/png;base64,{dto.ProfilePictureBase64}";
            }
            else
            {
                Error = "Usuario no encontrado.";
            }
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        try
        {
            _selectedFile = e.File;
            var maxBytes = 1024 * 1024;
            using var stream = _selectedFile.OpenReadStream(maxAllowedSize: maxBytes);
            var buffer = new byte[_selectedFile.Size > maxBytes ? maxBytes : (int)_selectedFile.Size];
            await stream.ReadAsync(buffer, 0, buffer.Length);
            var base64 = Convert.ToBase64String(buffer);
            ProfilePreview = $"data:{_selectedFile.ContentType};base64,{base64}";
            // Optionally: Model.ProfilePictureBase64 = base64;
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error leyendo archivo: " + ex.Message, Severity.Error);
        }
    }

    private async Task SaveAsync()
    {
        Error = "";
        try
        {
            IsProcessing = true;

            if (form is not null)
            {
                await form.Validate();
                if (!form.IsValid)
                {
                    Error = "Por favor corrija los campos requeridos.";
                    return;
                }
            }

            if (IsCreate)
            {
                var create = new CreateUserModel
                {
                    Email = Model.Email ?? "",
                    UserName = Model.UserName ?? "",
                    Password = await PromptPasswordAsync(),
                    PhoneNumber = Model.PhoneNumber,
                    TenantId = Model.TenantId
                };

                if (string.IsNullOrEmpty(create.Password))
                {
                    Error = "Password requerida para crear usuario.";
                    return;
                }

                var resp = await UserService.CreateUserAsync(create);
                if (!resp.IsSuccessStatusCode)
                {
                    var txt = await resp.Content.ReadAsStringAsync();
                    Error = $"Error creando usuario: {resp.StatusCode} - {txt}";
                    return;
                }

                Snackbar.Add("Usuario creado", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var update = new UpdateUserModel
                {
                    Email = Model.Email,
                    UserName = Model.UserName,
                    PhoneNumber = Model.PhoneNumber,
                    FirstName = Model.FirstName,
                    LastName = Model.LastName,
                    Address = Model.Address,
                    IsEnabled = Model.IsEnabled,
                    TenantId = _isSuperAdmin ? Model.TenantId : null
                };

                var resp = await UserService.UpdateUserAsync(Model.Id, update);
                if (!resp.IsSuccessStatusCode)
                {
                    var txt = await resp.Content.ReadAsStringAsync();
                    Error = $"Error actualizando usuario: {resp.StatusCode} - {txt}";
                    return;
                }

                Snackbar.Add("Usuario actualizado", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
        catch (Exception ex)
        {
            Error = ex.Message;
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private Task<string> PromptPasswordAsync()
    {
        // Implementar UI real si quieres crear usuarios desde el modal.
        return Task.FromResult(string.Empty);
    }

    private void Cancel() => MudDialog.Cancel();
}