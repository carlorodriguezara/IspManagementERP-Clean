@using MudBlazor
@inject IspManagementERP.Client.Services.Identity.UserService UserService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Claims — @UserEmail</MudText>
        <MudDivider Class="my-2" />

        @if (IsLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
            </div>
        }
        else
        {
            <MudText Typo="Typo.subtitle2" Class="mb-1">Asignados</MudText>
            @if (UserClaims == null || !UserClaims.Any())
            {
                <MudText color="Color.Secondary">No tiene claims.</MudText>
            }
            else
            {
                <MudList Dense="true">
                    @foreach (var c in UserClaims)
                    {
                        <MudListItem>
                            <MudText>@c.Key: @c.Value</MudText>
                            <MudSpacer />
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="() => RemoveClaim(c.Key, c.Value)" Disabled="@IsProcessing">Quitar</MudButton>
                        </MudListItem>
                    }
                </MudList>
            }

            <MudDivider Class="my-2" />

            <MudText Typo="Typo.subtitle2" Class="mb-1">Agregar claim</MudText>
            <div class="d-flex gap-2 align-center">
                <MudTextField @bind-Value="NewClaimType" Placeholder="Tipo" />
                <MudTextField @bind-Value="NewClaimValue" Placeholder="Valor" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddClaim" Disabled="@IsProcessing">Agregar</MudButton>
            </div>
        }

        @if (!string.IsNullOrEmpty(Error))
        {
            <MudAlert Severity="Severity.Error" Elevation="0" Class="mt-2">@Error</MudAlert>
        }
    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Close">Cerrar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string UserId { get; set; } = "";
    [Parameter] public string UserEmail { get; set; } = "";

    private bool IsLoading;
    private bool IsProcessing;
    private string NewClaimType = "";
    private string NewClaimValue = "";
    private List<KeyValuePair<string, string>> UserClaims = new();
    private string? Error;

    protected override async Task OnInitializedAsync()
    {
        await LoadClaimsAsync();
    }

    private async Task LoadClaimsAsync()
    {
        try
        {
            IsLoading = true;
            Error = null;
            var claims = await UserService.GetUserClaimsAsync(UserId);
            UserClaims = claims?.Select(kv => new KeyValuePair<string, string>(kv.Key, kv.Value)).ToList() ?? new List<KeyValuePair<string, string>>();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task AddClaim()
    {
        try
        {
            IsProcessing = true;
            var resp = await UserService.AddUserClaimAsync(UserId, new KeyValuePair<string,string>(NewClaimType, NewClaimValue));
            if (!resp.IsSuccessStatusCode)
            {
                var txt = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error agregando claim: {txt}", Severity.Error);
            }
            else
            {
                Snackbar.Add("Claim agregado", Severity.Success);
                NewClaimType = "";
                NewClaimValue = "";
            }
            await LoadClaimsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task RemoveClaim(string type, string value)
    {
        try
        {
            IsProcessing = true;
            var resp = await UserService.RemoveUserClaimAsync(UserId, type, value);
            if (!resp.IsSuccessStatusCode)
            {
                var txt = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error quitando claim: {txt}", Severity.Error);
            }
            else
            {
                Snackbar.Add("Claim removido", Severity.Success);
            }
            await LoadClaimsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private void Close() => MudDialog.Close();
}