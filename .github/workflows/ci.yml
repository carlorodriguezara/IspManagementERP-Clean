on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master", "develop" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: "nuget-${{ runner.os }}-${{ hashFiles('**/*.sln','**/*.csproj') }}"
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore .NET (root solution)
        run: |
          dotnet restore

      - name: Build solution
        run: |
          dotnet build --no-restore --configuration Release

      - name: Run server/unit tests
        run: |
          dotnet test --no-build --configuration Release --logger "trx;LogFileName=tests.trx" --results-directory ./test-results

      - name: Upload dotnet test results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-test-results
          path: ./test-results

      - name: Detect client folder (IspManagementERP.Client)
        id: detect-client
        run: |
          if [ -d "./IspManagementERP.Client" ]; then
            echo "client_exists=true" >> $GITHUB_OUTPUT
          else
            echo "client_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install client dependencies (npm)
        if: ${{ steps.detect-client.outputs.client_exists == 'true' }}
        working-directory: ./IspManagementERP.Client
        run: |
          npm ci

      - name: Run client unit/lint tests (if any)
        if: ${{ steps.detect-client.outputs.client_exists == 'true' }}
        working-directory: ./IspManagementERP.Client
        run: |
          if npm run | grep -q "test"; then
            npm test --if-present
          fi

      - name: Optional: Run Playwright E2E
        if: ${{ steps.detect-client.outputs.client_exists == 'true' && (env.RUN_E2E == 'true' || github.event.inputs.run_e2e == 'true') }}
        working-directory: ./IspManagementERP.Client
        run: |
          npm i -D @playwright/test@latest
          npx playwright install --with-deps
          npx playwright test --reporter=dotnet

      - name: Upload client test artifacts
        if: ${{ steps.detect-client.outputs.client_exists == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: client-artifacts
          path: |
            IspManagementERP.Client/test-results
            IspManagementERP.Client/playwright-report

  codeql-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: csharp, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Run CodeQL query
        uses: github/codeql-action/analyze@v2
        with:
          category: '/language:security'