name: CI/CD (Lite) - Build and Controlled Deploy

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  DOTNET_VERSION: '7.0.x'
  WEB_PROJECT_PATH: './IspManagementERP/Server/IspManagementERP.Server.csproj'
  DBUP_PROJECT_PATH: './IspManagementERP.DbUp/IspManagementERP.DbUp.csproj'
  AZURE_WEBAPP_NAME: 'IspManagementGlobal'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET (build)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore & Build
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore

      - name: Publish web project (artifact)
        run: |
          dotnet publish "${{ env.WEB_PROJECT_PATH }}" -c Release -o ./publish

      - name: Create zip of published files
        run: |
          # create zip named web-publish.zip containing the publish folder contents
          if [ -d "./publish" ]; then
            cd publish
            zip -r ../web-publish.zip . || true
            cd ..
            ls -la web-publish.zip
          else
            echo "ERROR: ./publish no existe en build"
            ls -la
            exit 1
          fi

      - name: Upload artifact (web zip)
        uses: actions/upload-artifact@v4
        with:
          name: web-publish
          path: web-publish.zip

  predeploy_checks:
    needs: build
    runs-on: ubuntu-latest
    env:
      AZURE_SQL_CONNECTION_STRING_STAGING: ${{ secrets.AZURE_SQL_CONNECTION_STRING_STAGING }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET (required for running DbUp)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download publish artifact (for checks)
        uses: actions/download-artifact@v4
        with:
          name: web-publish
          path: ./artifact

      - name: Debug:listar archivos y dotnet info (opcional)
        run: |
          echo "PWD: $(pwd)"
          echo "Listado raiz:"
          ls -la
          echo "Contenido ./artifact:"
          ls -la ./artifact || true
          echo "Si existe zip, mostrar tamaño:"
          if [ -f ./artifact/web-publish.zip ]; then
            echo "web-publish.zip:"
            ls -lh ./artifact/web-publish.zip
          fi
          echo "Buscar csproj DbUp:"
          find . -maxdepth 6 -type f -name "*.csproj" -print || true
          dotnet --info

      - name: (Opcional) Run DbUp against STAGING/DEV
        if: ${{ env.AZURE_SQL_CONNECTION_STRING_STAGING != '' }}
        env:
          ConnectionStrings__DefaultConnection: ${{ env.AZURE_SQL_CONNECTION_STRING_STAGING }}
        run: |
          echo "Running DbUp against STAGING/DEV (optional)..."
          dotnet run --project "${{ env.DBUP_PROJECT_PATH }}" --configuration Release

      - name: Smoke test built artifact (placeholder)
        run: |
          echo "Add real smoke tests here if you have them."

  deploy_to_prod:
    needs: predeploy_checks
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://ispmanagementglobal.azurewebsites.net
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET (required for running DbUp in deploy job)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: web-publish
          path: ./artifact

      - name: Debug:listar artifact antes de deploy (obligatorio para diagnóstico)
        run: |
          echo "PWD: $(pwd)"
          echo "Listando raíz:"
          ls -la
          echo "Listando ./artifact (artifact descargado):"
          ls -la ./artifact || echo "NO existe ./artifact"
          echo "Contenido recursivo ./artifact:"
          find ./artifact -maxdepth 3 -type f -print || true
          echo "Si se desea, listar contenido del zip:"
          if [ -f ./artifact/web-publish.zip ]; then
            unzip -l ./artifact/web-publish.zip | head -n 50 || true
          fi

      - name: Prepare package for azure/webapps-deploy
        run: |
          # ensure package exists and is at ./artifact/web-publish.zip
          if [ -f "./artifact/web-publish.zip" ]; then
            echo "Artifact zip encontrado: ./artifact/web-publish.zip"
          else
            echo "ERROR: ./artifact/web-publish.zip NO existe. List current dir:"
            ls -la
            exit 1
          fi

      - name: (Recomendado) Backup PROD DB BEFORE migrations
        run: |
          echo "Ensure you performed a backup before approving deploy to PROD."

      - name: Run DbUp migrations on PROD
        env:
          ConnectionStrings__DefaultConnection: ${{ secrets.AZURE_SQL_CONNECTION_STRING_PROD }}
        run: |
          echo "Running DbUp against PROD (after approval)..."
          dotnet run --project "${{ env.DBUP_PROJECT_PATH }}" --configuration Release

      - name: Deploy to Azure (production)
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./artifact/web-publish.zip
