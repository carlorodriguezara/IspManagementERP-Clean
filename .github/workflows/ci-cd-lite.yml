name: CI/CD (Lite) - Build and Controlled Deploy

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  DOTNET_VERSION: '7.0.x'
  WEB_PROJECT_PATH: './IspManagementERP/Server/IspManagementERP.Server.csproj'
  DBUP_PROJECT_PATH: './IspManagementERP.DbUp/IspManagementERP.DbUp.csproj'
  AZURE_WEBAPP_NAME: 'IspManagementGlobal'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET (build)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore & Build
        run: |
          dotnet restore
          dotnet build --configuration Release --no-restore

      - name: Publish web project
        run: |
          dotnet publish "${{ env.WEB_PROJECT_PATH }}" -c Release -o ./publish

      - name: Publish DbUp project
        run: |
          dotnet publish "${{ env.DBUP_PROJECT_PATH }}" -c Release -o ./dbup_publish

      - name: Create zip of published web
        run: |
          if [ -d "./publish" ]; then
            cd publish
            zip -r ../web-publish.zip . || true
            cd ..
          else
            echo "ERROR: ./publish no existe en build"
            ls -la
            exit 1
          fi

      - name: Create zip of published DbUp
        run: |
          if [ -d "./dbup_publish" ]; then
            cd dbup_publish
            zip -r ../dbup-publish.zip . || true
            cd ..
          else
            echo "ERROR: ./dbup_publish no existe en build"
            ls -la
            exit 1
          fi

      - name: Upload web artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: web-publish
          path: web-publish.zip

      - name: Upload dbup artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: dbup-publish
          path: dbup-publish.zip

  predeploy_checks:
    needs: build
    runs-on: ubuntu-latest
    env:
      AZURE_SQL_CONNECTION_STRING_STAGING: ${{ secrets.AZURE_SQL_CONNECTION_STRING_STAGING }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET (required for optional DbUp checks)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download web artifact (for checks)
        uses: actions/download-artifact@v4
        with:
          name: web-publish
          path: ./artifact_web

      - name: Download dbup artifact (for checks)
        uses: actions/download-artifact@v4
        with:
          name: dbup-publish
          path: ./artifact_dbup

      - name: Unzip dbup artifact (if present)
        run: |
          if [ -f ./artifact_dbup/dbup-publish.zip ]; then
            rm -rf ./artifact_dbup/unzipped || true
            mkdir -p ./artifact_dbup/unzipped
            unzip -q ./artifact_dbup/dbup-publish.zip -d ./artifact_dbup/unzipped || true
            echo "Unzip completed for checks."
          else
            echo "No se encontró ./artifact_dbup/dbup-publish.zip — se omiten los checks de DbUp (opcional)"
          fi

      - name: (Opcional) Run DbUp against STAGING/DEV
        if: ${{ env.AZURE_SQL_CONNECTION_STRING_STAGING != '' }}
        env:
          ConnectionStrings__DefaultConnection: ${{ env.AZURE_SQL_CONNECTION_STRING_STAGING }}
        run: |
          set -euo pipefail
          echo "Optional: run DbUp against STAGING using the published artifact..."
          if [ -f ./artifact_dbup/dbup-publish.zip ]; then
            rm -rf ./artifact_dbup/unzipped || true
            mkdir -p ./artifact_dbup/unzipped
            unzip -q ./artifact_dbup/dbup-publish.zip -d ./artifact_dbup/unzipped || true
            echo "Listing unzipped files (first 200 entries):"
            find ./artifact_dbup/unzipped -type f | sed -n '1,200p'
            DBUP_DLL=$(find ./artifact_dbup/unzipped -type f -name "IspManagementERP.DbUp.dll" 2>/dev/null | head -n1 || true)
          else
            echo "No dbup-publish.zip found in artifact_dbup - skipping optional DbUp staging run."
            exit 0
          fi

          if [ -z "$DBUP_DLL" ]; then
            echo "ERROR: IspManagementERP.DbUp.dll not found inside unzipped artifact. See files above."
            ls -la ./artifact_dbup/unzipped || true
            exit 1
          fi

          echo "Found DbUp DLL: $DBUP_DLL"
          DBUP_DIR=$(dirname "$DBUP_DLL")
          echo "Running dotnet <dll> from directory: $DBUP_DIR"
          ls -la "$DBUP_DIR" || true
          dotnet "$DBUP_DLL"

  deploy_to_prod:
    needs: predeploy_checks
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://ispmanagementglobal.azurewebsites.net
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET (required for running DbUp in deploy job)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download web artifact
        uses: actions/download-artifact@v4
        with:
          name: web-publish
          path: ./artifact_web

      - name: Download dbup artifact
        uses: actions/download-artifact@v4
        with:
          name: dbup-publish
          path: ./artifact_dbup

      - name: Debug .NET and unzip info
        run: |
          set -euo pipefail
          echo "dotnet --info"
          dotnet --info || true
          echo "List artifact_dbup contents (top):"
          ls -la ./artifact_dbup || true
          if [ -f ./artifact_dbup/dbup-publish.zip ]; then
            echo "dbup-publish.zip exists"
          else
            echo "dbup-publish.zip NOT found"
          fi

      - name: Run DbUp migrations on PROD (unzip all & run)
        env:
          ConnectionStrings__DefaultConnection: ${{ secrets.AZURE_SQL_CONNECTION_STRING_PROD }}
        run: |
          set -euo pipefail
          echo "Preparing to run DbUp on PROD..."
          rm -rf ./artifact_dbup/unzipped_from_zip || true
          mkdir -p ./artifact_dbup/unzipped_from_zip

          if [ -f ./artifact_dbup/dbup-publish.zip ]; then
            echo "Unzipping entire dbup-publish.zip to ./artifact_dbup/unzipped_from_zip ..."
            unzip -q ./artifact_dbup/dbup-publish.zip -d ./artifact_dbup/unzipped_from_zip || true
          else
            echo "ERROR: ./artifact_dbup/dbup-publish.zip not found. Listing artifact_dbup:"
            ls -la ./artifact_dbup || true
            exit 1
          fi

          echo "Listing extracted files (first 300 entries):"
          find ./artifact_dbup/unzipped_from_zip -type f | sed -n '1,300p' || true
          echo "---- end list ----"

          # Prefer a folder that contains runtimeconfig.json (framework-dependent publish)
          RUNTIME_FILE=$(find ./artifact_dbup/unzipped_from_zip -type f -name "IspManagementERP.DbUp.runtimeconfig.json" -print -quit || true)

          if [ -n "$RUNTIME_FILE" ]; then
            DBUP_DIR=$(dirname "$RUNTIME_FILE")
            DBUP_DLL=$(find "$DBUP_DIR" -maxdepth 1 -type f -name "IspManagementERP.DbUp.dll" -print -quit || true)
            echo "Found runtimeconfig.json at: $RUNTIME_FILE"
          else
            echo "No runtimeconfig.json found next to any files. Searching for any IspManagementERP.DbUp.dll..."
            DBUP_DLL=$(find ./artifact_dbup/unzipped_from_zip -type f -name "IspManagementERP.DbUp.dll" -print -quit || true)
            if [ -n "$DBUP_DLL" ]; then
              DBUP_DIR=$(dirname "$DBUP_DLL")
              echo "Found DbUp DLL at: $DBUP_DLL but no runtimeconfig.json next to it."
            fi
          fi

          if [ -z "${DBUP_DLL:-}" ]; then
            echo "ERROR: IspManagementERP.DbUp.dll not found inside extracted artifact."
            echo "Contents of artifact_dbup/unzipped_from_zip (full):"
            find ./artifact_dbup/unzipped_from_zip -type f -print || true
            exit 1
          fi

          echo "Using DBUP_DLL = $DBUP_DLL"
          echo "Listing directory $DBUP_DIR for inspection:"
          ls -la "$DBUP_DIR" || true

          # Show the main runtime files if present
          echo "Looking for runtime files next to dll:"
          for f in "$DBUP_DIR"/IspManagementERP.DbUp.*; do
            [ -e "$f" ] && echo "  $f"
          done || true

          # Final sanity: ensure the connection string env var is defined
          echo "ConnectionStrings__DefaultConnection present? ${ConnectionStrings__DefaultConnection:+yes}" || true

          echo "Attempting to run the DbUp DLL with dotnet from $DBUP_DIR"
          pushd "$DBUP_DIR" > /dev/null || true
          echo "pwd: $(pwd)"
          echo "ls -la"
          ls -la
          echo "Running: dotnet \"${DBUP_DLL##*/}\""
          dotnet "${DBUP_DLL##*/}" || true
          popd > /dev/null || true

          # If the above failed, fallback to running dotnet run from source (less preferred)
          if [ $? -ne 0 ]; then
            echo "dotnet <dll> returned non-zero exit code — attempting fallback dotnet run (source) as diagnostic"
            dotnet run --project "${{ env.DBUP_PROJECT_PATH }}" --configuration Release -- "${ConnectionStrings__DefaultConnection:-}" || true
          fi

      - name: Deploy web to Azure (production)
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./artifact_web/web-publish.zip
